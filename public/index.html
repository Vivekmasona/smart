<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Vercel Mini Browser - Download Overlay</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body,html{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif}
    #top{padding:10px;background:#111;color:#fff;display:flex;gap:8px;align-items:center}
    #url{flex:1;padding:8px;border-radius:6px;border:1px solid #444;background:#222;color:#fff}
    button{padding:8px 10px;border-radius:6px;border:none;cursor:pointer}
    #frameWrap{position:relative;height:calc(100% - 56px)}
    iframe{width:100%;height:100%;border:0;background:#fff}
    .overlay{position:absolute;right:12px;top:12px;background:rgba(0,0,0,0.7);color:#fff;padding:10px;border-radius:8px;max-width:360px}
    .item{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
    .title{max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  </style>
</head>
<body>
  <div id="top">
    <input id="url" placeholder="https://example.com" />
    <button id="go">Go</button>
  </div>

  <div id="frameWrap">
    <iframe id="vframe" srcdoc="<p style='padding:20px'>Enter URL above and click Go</p>"></iframe>
    <div id="overlay" class="overlay" style="display:none">
      <div><strong>Detected media</strong></div>
      <div id="items"></div>
    </div>
  </div>

  <script>
    const iframe = document.getElementById('vframe');
    const overlay = document.getElementById('overlay');
    const itemsDiv = document.getElementById('items');

    document.getElementById('go').addEventListener('click', ()=>{
      const url = document.getElementById('url').value.trim();
      if(!url) return alert('Enter URL');
      // Use our serverless proxy
      iframe.src = '/api/proxy?url=' + encodeURIComponent(url);
      overlay.style.display = 'none';
      itemsDiv.innerHTML = '';
    });

    window.addEventListener('message', ev => {
      if(!ev.data || ev.data.type !== 'foundMedia') return;
      const items = ev.data.items || [];
      if(items.length === 0){
        overlay.style.display = 'none';
        itemsDiv.innerHTML = '';
        return;
      }
      itemsDiv.innerHTML = '';
      items.forEach(it => {
        const row = document.createElement('div');
        row.className = 'item';
        const t = document.createElement('div');
        t.className = 'title';
        t.textContent = it.title || it.url;
        const btn = document.createElement('button');
        btn.textContent = 'Download';
        btn.onclick = () => {
          const dl = '/api/download?url=' + encodeURIComponent(it.url);
          // open in new tab so browser handles download; server may redirect for large files
          window.open(dl, '_blank');
        };
        row.appendChild(t);
        row.appendChild(btn);
        itemsDiv.appendChild(row);
      });
      overlay.style.display = 'block';
    });

    // Optionally auto-load a default page
    // iframe.src = '/api/proxy?url=' + encodeURIComponent('https://example.com');
  </script>
</body>
</html>
